/* qrcode.js -- QR code generator in Javascript (revision 2011-01-19)
 * Written by Kang Seonghoon <public+qrjs@mearie.org>.
 *
 * This source code is in the public domain; if your jurisdiction does not
 * recognize the public domain the terms of Creative Commons CC0 license
 * apply. In the other words, you can always do what you want.
 */
(function(root,name,definition){if(typeof define==="function"&&define.amd){define([],definition)}else if(typeof module==="object"&&module.exports){module.exports=definition()}else{root[name]=definition()}})(this,"QRCode",function(){"use strict";var VERSIONS=[null,[10,7,17,13],[16,10,28,22],[26,15,22,18],[18,20,16,26],[24,26,22,18],[16,18,28,24],[18,20,26,18],[22,24,26,22],[22,30,24,20],[26,18,28,24],[30,20,24,28],[22,24,28,26],[22,26,22,24],[24,30,24,20],[24,22,24,30],[28,24,30,24],[28,28,28,28],[26,30,28,24],[26,28,26,28],[26,28,26,30],[28,28,26,28],[28,30,28,24],[28,30,28,30],[28,30,30,30],[28,30,30,30],[28,28,30,30],[28,30,30,30],[28,30,30,30],[28,30,30,30]],ALIGNMENT_DELTA=[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28],ALPHANUMERIC_MAP={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25," ":26,$:27,"%":28,"*":29,"+":30,"-":31,".":32,"/":33,":":34};function glog(n){if(n<1)throw new Error("glog("+n+")");return LOG_TABLE[n]}function gexp(n){while(n<0)n+=255;while(n>=256)n-=255;return EXP_TABLE[n]}var EXP_TABLE=new Array(256),LOG_TABLE=new Array(256);for(var i=0;i<8;++i)EXP_TABLE[i]=1<<i;for(var i=8;i<256;++i)EXP_TABLE[i]=EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8];for(var i=0;i<255;++i)LOG_TABLE[EXP_TABLE[i]]=i;function Polynomial(coefficients){if(coefficients.length==0)throw new Error("no coefficients");this.coefficients=coefficients;this.degree=coefficients.length-1;this.zero=coefficients[0]===0}Polynomial.prototype={get:function(index){return this.coefficients[this.coefficients.length-1-index]},getLength:function(){return this.coefficients.length},multiply:function(e){var target=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();++i)for(var j=0;j<e.getLength();++j)target[i+j]^=gexp(glog(this.get(i))+glog(e.get(j)));return new Polynomial(target)},mod:function(e){var target=this.coefficients.slice(0);while(target.length-1>=e.degree){if(target[0]!==0){for(var i=0;i<=e.degree;++i)target[i]^=gexp(glog(e.get(i))+glog(target[0]))}target.shift()}return new Polynomial(target)}};function syndromePolynomial(msg,nsym){var poly=new Polynomial([1]);for(var i=0;i<nsym;++i)poly=poly.multiply(new Polynomial([1,gexp(i)]));return poly}function bmGlobal(msg,nsym,genpoly,erasures){var r=new Array(msg.length+nsym);for(var i=0;i<msg.length;++i)r[i]=msg[i];for(var i=msg.length;i<r.length;++i)r[i]=0;var msg=new Polynomial(r);msg=msg.multiply(new Polynomial(new Array(nsym+1).concat([1])));var syndrome=msg.mod(genpoly);var syndromestr=syndrome.coefficients.join(",");if(syndromestr.replace(/0/g,"").length==0)return r.slice(msg.length);var sigma=new Polynomial([1]),omega=new Polynomial([1]);var errors=0;for(var i=0;i<erasures.length;++i){var term=new Polynomial([1,gexp(erasures[i])]);sigma=sigma.multiply(term);var inverse=gexp(255-erasures[i]);omega=omega.multiply(new Polynomial([inverse,0]))}var syndpoly=new Polynomial(syndrome.coefficients.slice(0).reverse());var error=false;for(var i=0;i<nsym;++i){var evalpoly=syndpoly.get(i);if(evalpoly!==0)error=true}if(error){var lhs=sigma.multiply(syndpoly).mod(new Polynomial(new Array(nsym+1).concat([1]))),rhs=new Polynomial(new Array(nsym).concat(omega.coefficients));var tau=lhs.multiply(rhs);var omega=tau.coefficients.slice(tau.coefficients.length-nsym);omega.reverse();var sigma=tau.coefficients.slice(0,tau.coefficients.length-nsym);sigma.reverse();var errors=sigma.length-1;var errorpos=[];for(var i=0;i<255;++i){var c=gexp(i);var evalpoly=sigma.reduce(function(acc,s,j){return acc+s*Math.pow(c,j)},0);if(evalpoly===0)errorpos.push(255-i)}if(errorpos.length!=errors)return null;var errordata=[];for(var i=0;i<errorpos.length;++i){var pos=errorpos[i];var magnitude=omega.reduce(function(acc,w,j){return acc+w*Math.pow(gexp(pos),j)},0);var mangitude_inv=gexp(255-glog(magnitude));errordata.push([pos,mangitude_inv])}for(var i=0;i<errordata.length;++i){var pos=errordata[i][0],magnitude=errordata[i][1];r[pos]=r[pos]^magnitude}}return r.slice(0,msg.length)}function calculateMaskPenalty(matrix){var penalty=0;var size=matrix.length;for(var y=0;y<size;++y){var run=-1,color=-1;for(var x=0;x<size;++x){if(matrix[y][x]==color)++run;else{if(run>=5)penalty+=run-2;run=1;color=matrix[y][x]}}}for(var x=0;x<size;++x){var run=-1,color=-1;for(var y=0;y<size;++y){if(matrix[y][x]==color)++run;else{if(run>=5)penalty+=run-2;run=1;color=matrix[y][x]}}}var black=0;for(var y=0;y<size;++y)for(var x=0;x<size;++x)if(matrix[y][x])++black;penalty+=10*Math.floor(Math.abs(black/size/size-.5)*20);for(var y=0;y<size-1;++y)for(var x=0;x<size-1;++x){var factor=0;if(matrix[y][x])++factor;if(matrix[y][x+1])++factor;if(matrix[y+1][x])++factor;if(matrix[y+1][x+1])++factor;if(factor==0||factor==4)penalty+=3}for(var y=0;y<size;++y)for(var x=0;x<size-6;++x){if(matrix[y][x]&&!matrix[y][x+1]&&matrix[y][x+2]&&matrix[y][x+3]&&matrix[y][x+4]&&!matrix[y][x+5]&&matrix[y][x+6])penalty+=40}for(var x=0;x<size;++x)for(var y=0;y<size-6;++y){if(matrix[y][x]&&!matrix[y+1][x]&&matrix[y+2][x]&&matrix[y+3][x]&&matrix[y+4][x]&&!matrix[y+5][x]&&matrix[y+6][x])penalty+=40}return penalty}function generateMatrix(version,ecclevel,data,mask){var v=VERSIONS[version],ec=v[ecclevel],size=17+4*version,matrix=[];for(var i=0;i<size;++i)matrix[i]=new Array(size);for(var i=0;i<size;++i)for(var j=0;j<size;++j)matrix[i][j]=null;for(var i=0;i<8;++i){for(var j=0;j<8;++j){if(!(i==7&&j==7||i>=size-8&&j<8||i<8&&j>=size-8))matrix[i][j]=matrix[size-i-1][j]=matrix[i][size-j-1]=(i+j)%2==0}}for(var i=8;i<size-8;++i)matrix[i][6]=matrix[6][i]=i%2==0;var alignpos=v[2],m=alignpos.length;for(var i=0;i<m;++i)for(var j=0;j<m;++j){if(alignpos[i]==6&&alignpos[j]==6||alignpos[i]==6&&alignpos[j]==size-7||alignpos[i]==size-7&&alignpos[j]==6)continue;for(var ii=-2;ii<=2;++ii)for(var jj=-2;jj<=2;++jj)matrix[alignpos[i]+ii][alignpos[j]+jj]=ii==0&&jj==0||ii==2||ii==-2||jj==2||jj==-2}for(var i=0;i<18;++i){var num=ec<<3|Math.floor(i/3);matrix[Math.floor(i/3)][i%3+size-8-3]=matrix[i%3+size-8-3][Math.floor(i/3)]=num&1<<i%8?1:0}for(var i=0;i<size;++i)matrix[i][8]=matrix[8][i]=i%2==0;var bytes=data.length,y=size-1,pos=0;for(var i=0;i<bytes;++i){var ch=data[i];for(var j=7;j>=0;--j,++pos){var x=pos/8*2,dir=(pos/8)%2;if(dir==0)x=size-1-x;matrix[y-x%2][Math.floor(x/2)-Math.floor(pos/16)]=ch&1<<j?1:0}}}function QRCode(text,options){options=options||{};var version=options.version||-1,ecclevel=options.ecclevel||1,mode=options.mode||0;if(mode<0||mode>3)throw new Error("invalid or unsupported mode");if(ecclevel<0||ecclevel>3)throw new Error("invalid or unsupported error correction level");var dataenc=function(data){switch(mode){case 0:return encodeNumeric(data);case 1:return encodeAlphanumeric(data);case 2:return encode8bit(data);case 3:return encodeKanji(data)}},datacount=function(version){switch(mode){case 0:return[10,12,14][version-1];case 1:return[9,11,13][version-1];case 2:return[8,16,16][version-1];case 3:return[8,10,12][version-1]}},eccsize=function(version,ecclevel){return VERSIONS[version][ecclevel]*datacount(version)};var maxsize=function(ecclevel){for(var i=1;i<=40;++i){var size=4*i+17;var bytes=(size*size/8|0)-(15+i*2+1);var words=bytes/8|0;var maxwords=words-VERSIONS[i][ecclevel]*datacount(i);switch(mode){case 0:var bits=maxwords*3+maxwords%3;return Math.floor(bits/10*3);case 1:var bits=maxwords*11;return Math.floor(bits/10*2);case 2:return maxwords;case 3:return Math.floor(maxwords/2)}}};var validatedata=function(data){switch(mode){case 0:return data.match(NUMERIC_REGEXP);case 1:return data.match(ALPHANUMERIC_REGEXP);case 2:return true;case 3:return data.length%2==0}};if(version<0){for(var i=1;i<=40;++i){if(text.length<=maxsize(i)){version=i;break}}if(version<0)throw new Error("input too long")}else if(text.length>maxsize(version)){throw new Error("input too long for specified version")}if(!validatedata(text))throw new Error("invalid input data");var buf=[];var bits=0,remaining=8;function pack(x,n){if(n>=remaining){buf.push(bits|x>>n-remaining);bits=x<<remaining&255;remaining+=8}else{bits|=x<<remaining-n;remaining-=n}}function flush(){if(remaining<8)buf.push(bits)}if(mode==0){var acc=0,cnt=0;for(var i=0;i<text.length;++i){var c=text.charCodeAt(i)-48;acc=acc*10+c;++cnt;if(cnt==3||i==text.length-1){pack(acc,cnt*3+cnt%3);acc=0;cnt=0}}}else if(mode==1){for(var i=0;i<text.length;++i){var c=text.charAt(i);if(c<"0"||c>"9"&&c<"A"||c>"Z"&&c!=" "&&c!="$"&&c!="%"&&c!="*"&&c!="+"&&c!="-"&&c!="."&&c!="/"&&c!=":")throw new Error("invalid alphanumeric data: "+c);var val=ALPHANUMERIC_MAP[c];if(i%2==0){acc=val;++cnt}else{pack(acc*45+val,11);acc=0;cnt=0}}if(cnt)pack(acc,6)}else if(mode==2){for(var i=0;i<text.length;++i){var c=text.charCodeAt(i);pack(c,8)}}else{for(var i=0;i<text.length;i+=2){var c=text.charCodeAt(i)*256+text.charCodeAt(i+1);pack(c,13)}}flush();var size=17+4*version,matrix=[];for(var i=0;i<size;++i)matrix[i]=new Array(size);var ecbytes=eccsize(version,ecclevel),datalen=buf.length;if(datalen<ecbytes-2){buf.push(0);while(buf.length<ecbytes-2)buf.push(Math.floor(Math.random()*254)+1);buf.push(0,0)}else if(datalen>ecbytes-2)buf=buf.slice(0,ecbytes-2);buf.push(0,0);while(buf.length<ecbytes)buf.push(0);var poly=syndromePolynomial(buf,ecbytes-datalen),data=bmGlobal(buf,ecbytes-datalen,poly,[]);generateMatrix(version,ecclevel,data,0);this.modcount=4;this.version=version;this.ecclevel=ecclevel;this.size=size;this.data=matrix}QRCode.prototype={getModuleCount:function(){return this.size},isDark:function(row,col){return this.data[row][col]==1}};var NUMERIC_REGEXP=/^\d*$/,ALPHANUMERIC_REGEXP=/^[A-Z0-9 $%*+\-./:]*$/,ALPHANUMERIC_OUT_REGEXP=/^[A-Z0-9 $%*+\-./:]+$/;return QRCode});